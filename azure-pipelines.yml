trigger:
- production

variables:
  DOCKER_IMAGE_NAME: 'sanandres_api'
  DOCKER_NETWORK: 'san_andres'
  PORT: '5000:8080'
  
  group: SanAndres-Production

pool:
  name: Default

steps:
  # Paso 1: Checkout del c√≥digo
  - checkout: self
    clean: true
    fetchDepth: 1

  # Paso 2: Build de la imagen Docker
  - task: Docker@2
    displayName: 'Build Docker image'
    inputs:
      command: build
      repository: $(DOCKER_IMAGE_NAME)
      dockerfile: '**/Dockerfile'
      buildContext: '.'
      tags: latest

  # Paso 3: Detener y eliminar contenedor existente
  - script: |
      docker stop $(DOCKER_IMAGE_NAME) || true
      docker rm -v $(DOCKER_IMAGE_NAME) || true
    displayName: 'Remove existing container'

  # Paso 4: Ejecutar nuevo contenedor con todas las variables
  - script: |
      docker run -d \
        -p "$(PORT)" \
        --network "$(DOCKER_NETWORK)" \
        --name "$(DOCKER_IMAGE_NAME)" \
        -e "ConnectionStrings__DefaultConnection=$POSTGRES_CONNECTION_STRING" \
        -e "JwtSettings__Key=$JWT_SECRET_KEY" \
        -e "JwtSettings__Issuer=$JWT_ISSUER_URL" \
        -e "JwtSettings__Audience=$JWT_AUDIENCE_URL" \
        -e "JasperSettings__Server=$JASPER_SERVER" \
        -e "JasperSettings__Database=$JASPER_DATABASE" \
        -e "JasperSettings__User=$JASPER_USER" \
        -e "JasperSettings__Password=$JASPER_PASSWORD" \
        -e "CloudinarySettings__CloudName=$CLOUDINARY_NAME" \
        -e "CloudinarySettings__ApiKey=$CLOUDINARY_API_KEY" \
        -e "CloudinarySettings__ApiSecret=$CLOUDINARY_API_SECRET" \
        -e "Authentication__Google__ClientId=$GOOGLE_AUTH_CLIENT_ID" \
        -e "Authentication__Google__ClientSecretId=$GOOGLE_AUTH_CLIENT_SECRET" \
        -e "DriveSettings__ServiceAccountEmail=$GOOGLE_DRIVE_SERVICE_ACCOUNT" \
        -e "IaService=$IA_SERVICE_ENDPOINT" \
        "$(DOCKER_IMAGE_NAME):latest"
    displayName: 'Run Docker container'
    env:
      POSTGRES_CONNECTION_STRING: $(POSTGRES_CONNECTION_STRING)
      JWT_SECRET_KEY: $(JWT_SECRET_KEY)
      JWT_ISSUER_URL: $(JWT_ISSUER_URL)
      JWT_AUDIENCE_URL: $(JWT_AUDIENCE_URL)
      JASPER_SERVER: $(JASPER_SERVER)
      JASPER_DATABASE: $(JASPER_DATABASE)
      JASPER_USER: $(JASPER_USER)
      JASPER_PASSWORD: $(JASPER_PASSWORD)
      CLOUDINARY_NAME: $(CLOUDINARY_NAME)
      CLOUDINARY_API_KEY: $(CLOUDINARY_API_KEY)
      CLOUDINARY_API_SECRET: $(CLOUDINARY_API_SECRET)
      GOOGLE_AUTH_CLIENT_ID: $(GOOGLE_AUTH_CLIENT_ID)
      GOOGLE_AUTH_CLIENT_SECRET: $(GOOGLE_AUTH_CLIENT_SECRET)
      GOOGLE_DRIVE_SERVICE_ACCOUNT: $(GOOGLE_DRIVE_SERVICE_ACCOUNT)
      IA_SERVICE_ENDPOINT: $(IA_SERVICE_ENDPOINT)